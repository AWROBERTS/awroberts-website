server {
    listen 80;
    listen [::]:80;
    server_name awroberts.co.uk www.awroberts.co.uk;

    # TLS is terminated at the Ingress. Do not redirect here; Ingress handles HTTP->HTTPS.
    root  /usr/share/nginx/html;
    index index.html;

    # Ensure NGINX knows the font MIME type
    types {
        font/ttf  ttf;
    }

    # Default: serve static files or 404
    location / {
        try_files $uri $uri/ =404;
    }

    # CORS and strong caching only for TTF fonts in /awroberts-media/
    location ~* ^/awroberts-media/.*\.ttf$ {
        # Allow only our sites via Referer
        valid_referers none blocked awroberts.co.uk *.awroberts.co.uk saddleworth.machineopportunity.io;
        if ($invalid_referer) { return 403; }

        # CORS for Saddleworth only
        add_header Access-Control-Allow-Origin "https://saddleworth.machineopportunity.io" always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
        add_header Access-Control-Allow-Headers "*" always;
        add_header Vary "Origin" always;

        # Strong caching for fonts
        add_header Cache-Control "public, max-age=31536000, immutable" always;

        # Preflight (harmless even if unused)
        if ($request_method = OPTIONS) {
            return 204;
        }

        try_files $uri =404;
    }

    # Strong caching for TTF fonts anywhere on the site
    # Regex locations have higher precedence than prefix locations
    location ~* \.ttf$ {
        add_header Cache-Control "public, max-age=31536000, immutable" always;
        try_files $uri =404;
    }

    # Media path protection and general caching (non-font assets stay at 7d)
    # Use a plain prefix location so the .ttf regex above can win
    location /awroberts-media/ {
        valid_referers none blocked awroberts.co.uk *.awroberts.co.uk saddleworth.machineopportunity.io;
        if ($invalid_referer) { return 403; }

        expires 7d;
        add_header Cache-Control "public, max-age=604800" always;

        try_files $uri =404;
    }

    # Never serve certs
    location ^~ /awroberts-certs/ {
        return 404;
    }
}