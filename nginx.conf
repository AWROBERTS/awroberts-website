server {
    listen 80;
    listen [::]:80;
    server_name awroberts.co.uk www.awroberts.co.uk;

    # TLS is terminated at the Ingress. Do not redirect here; Ingress handles HTTP->HTTPS.
    root /usr/share/nginx/html;
    index index.html;

    # MIME types
    types {
        text/html html;
        font/ttf ttf;
        video/mp4 mp4;
    }

    # Serve root page and fallback to index.html for SPA routing
    location / {
        default_type text/html;
        try_files $uri $uri/ /index.html;
    }

    # Restrict direct access to background.mp4
    location ~* ^/awroberts-media/background\.mp4$ {
        # Allow only if Referer is from your root page
        valid_referers none blocked https://awroberts.co.uk https://www.awroberts.co.uk;
        if ($invalid_referer) {
            return 403;
        }

        # Optional: CORS headers for embedded playback
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Allow-Headers "*";
        add_header Vary "Origin";

        # Optional: handle preflight requests
        if ($request_method = OPTIONS) {
            return 204;
        }

        add_header Cache-Control "public, max-age=604800" always;
        try_files $uri =404;
    }

    # Serve other media files normally (e.g., images, audio)
    location /awroberts-media/ {
        expires 7d;
        add_header Cache-Control "public, max-age=604800" always;
        try_files $uri =404;
    }

    # Strong caching for fonts
    location ~* \.ttf$ {
        add_header Cache-Control "public, max-age=31536000, immutable" always;
        try_files $uri =404;
    }

    # Never serve certs
    location ^~ /awroberts-certs/ {
        return 404;
    }
}